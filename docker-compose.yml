# ============================================
# W2M - Docker Compose Configuration
# ============================================
#
# This single file supports all deployment modes:
#
#   Production (EC2 - uses image from GHCR):
#     docker-compose pull
#     docker-compose up -d
#
#   Development (local with hot-reload):
#     BUILD_TARGET=development NODE_ENV=development LOG_LEVEL=debug LOG_FORMAT=pretty \
#       docker-compose up --build
#
#   Production (local testing - build locally):
#     BUILD_TARGET=production docker-compose up --build
#
# Note: In production (EC2), the build section is ignored when using 'pull' first.
#       The image from GHCR will be used. The build section is only used when
#       explicitly building with --build flag or when BUILD_TARGET is set.

services:
  w2m:
    # Default (EC2): Use image from GHCR
    # When BUILD_TARGET is set: Build from local Dockerfile
    image: ${W2M_IMAGE:-ghcr.io/kirlts/w2m:latest}
    
    # Build configuration (only used when --build is specified or BUILD_TARGET is set)
    # In production (EC2), 'docker-compose pull' fetches the image from GHCR
    # and 'docker-compose up' uses that image, ignoring this build section
    build:
      context: .
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-production}
    
    container_name: w2m
    restart: unless-stopped
    stdin_open: true  # Allow interactive input
    tty: true         # Assign pseudo-TTY
    
    # Resource limits for EC2 t3.small (2GB RAM)
    deploy:
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 512M
    
    # Environment variables
    env_file:
      - .env
    
    environment:
      - NODE_OPTIONS=--max-old-space-size=${NODE_MAX_OLD_SPACE:-1024}
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=${TZ:-America/Santiago}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}
    
    # Volumes
    volumes:
      # WhatsApp session data (CRITICAL - do not lose)
      - ./data/session:/app/data/session
      
      # Vault with generated Markdown files
      - ./data/vault:/app/data/vault
      
      # Application logs
      - ./data/logs:/app/data/logs
      
      # Google Drive Service Account credentials
      # Note: Not :ro to allow permission adjustments
      - ./data/googledrive:/app/data/googledrive
      
      # Git configuration (if using SSH)
      - ~/.ssh:/home/w2m/.ssh:ro
      - ~/.gitconfig:/home/w2m/.gitconfig:ro
      
      # Timezone: mount host timezone if available (fallback to TZ env var)
      # Comment out if you prefer using only TZ environment variable
      - /etc/localtime:/etc/localtime:ro
      
      # Development only: mount source code for hot-reload
      # Only used when BUILD_TARGET=development
      - ./src:/app/src:ro
    
    # Ports
    ports:
      # Web Dashboard
      - "${WEB_PORT:-3000}:3000"
      
      # Development only: expose debugger port
      # Only used when BUILD_TARGET=development
      - "${DEBUG_PORT:-9229}:9229"
    
    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    networks:
      - w2m-network

networks:
  w2m-network:
    driver: bridge
